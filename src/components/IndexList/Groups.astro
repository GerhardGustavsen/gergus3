---
import PostList from "./Lists/MovieList.astro";
import GroupButtons from "./GroupsBtn.astro";

interface Props {
    media: any[];
    groupBy?: string[];
    favorites?: boolean;
}

const { media, groupBy = ["director", "year"], favorites = true } = Astro.props;

function fm(post: any) {
    return post.frontmatter ?? post.data ?? {};
}

function cmp(a: any, b: any) {
    const fa = fm(a);
    const fb = fm(b);
    const da = new Date(fa.date ?? 0).getTime();
    const db = new Date(fb.date ?? 0).getTime();
    return db - da; // newest first
}

// Build buckets for a given key (server-side)
function buildBuckets(key: string) {
    const buckets = new Map<string, any[]>();
    for (const post of media) {
        const f = fm(post);
        const raw = f[key];
        const k = raw == null || raw === "" ? `Unknown ${key}` : String(raw);
        if (!buckets.has(k)) buckets.set(k, []);
        buckets.get(k)!.push(post);
    }
    // sort inside each bucket
    for (const [, arr] of buckets) arr.sort(cmp);
    // sort bucket titles
    const groups = Array.from(buckets.keys()).sort((a, b) =>
        a.toLowerCase().localeCompare(b.toLowerCase()),
    );
    return { groups, buckets };
}

// Precompute all bucket-sets (one per key)
const prebuilt = groupBy.map((k) => ({ key: k, ...buildBuckets(k) }));

// Favorites (optional)
const favoritesList = favorites ? media.filter((p) => !!fm(p).favorite) : [];
---

{
    favorites && favoritesList.length > 0 && (
        <PostList posts={favoritesList} title="My all time favorites:" />
    )
}

<!-- buttons extracted -->
<GroupButtons keys={groupBy} />

{
    prebuilt.map(({ key, groups, buckets }, i) => (
        <section class={`groupset ${i === 0 ? "" : "hidden"}`} data-key={key}>
            {groups.map((g) => {
                const list = buckets.get(g) ?? [];
                if (list.length === 0) return null;
                return <PostList posts={list} title={g} />;
            })}
        </section>
    ))
}

<style>
    .hidden {
        display: none;
    }
</style>

<script is:inline>
    // listen for the bubbled event and toggle visibility (same behavior as before)
    document.addEventListener("groupby-change", (e) => {
        const key = e.detail?.key;
        if (!key) return;
        document
            .querySelectorAll(".groupset")
            .forEach((s) =>
                s.classList.toggle("hidden", s.dataset.key !== key),
            );
    });
</script>
